#!/boot/bin/sh
echo Welcome to magma autorun -- waiting for device
while [ ! -e /dev/class/gpu/000 ]; do
  echo "Device not found, sleeping"
  sleep 1
done

if [ -z ${GTEST_OUTPUT+x} ]; then
  gtest_output_arg=""
else
  gtest_output_arg=--gtest_output=$GTEST_OUTPUT
fi
echo [UNIT TEST START=]
/pkgfs/packages/magma_nonhardware_tests/0/test/magma_unit_tests
/pkgfs/packages/magma_arm_mali_nonhardware_tests/0/test/msd_arm_mali_nonhardware_tests
echo [UNIT TEST END===]
echo [INTEGRATION TEST START=]
run_test_component magma_abi_conformance_tests $gtest_output_arg
run_test_component msd_arm_mali_integration_tests $gtest_output_arg
if [ -e /pkgfs/packages/vulkan-tests/0/test/vkext ]; then
  run_test_component vkext --gtest_filter=-VulkanExtension.Scanout $gtest_output_arg
  run_test_component vkreadback $gtest_output_arg
else
  echo SKIPPED app tests - no /pkgfs/packages/vulkan-tests/0/test/vkext
fi
echo [INTEGRATION TEST END===]
