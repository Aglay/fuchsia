# Copyright 2020 The Fuchsia Authors
#
# Use of this source code is governed by a MIT-style
# license that can be found in the LICENSE file or at
# https://opensource.org/licenses/MIT

# TODO(54160): Keep this in sync with BUILD.zircon.gn

# The Multiboot trampoline gets its own toolchain to build x86-32 code.
if (current_toolchain == default_toolchain) {
  import("//build/toolchain/zircon/zircon_toolchain_suite.gni")

  multiboot_toolchain = "zircon_multiboot"

  # Define the special toolchain itself only in the default toolchain.
  zircon_toolchain_suite(multiboot_toolchain) {
    os = "fuchsia"
    cpu = "x64"
    environment = "multiboot"
    strip = "--strip-sections"
    toolchain_tags = [ "kernel" ]
    with_shared = false
    exclude_variant_tags = [ "instrumented" ]
    toolchain_variant_args = {
      configs = [ "//zircon/kernel/target/pc/multiboot:multiboot_config" ]
    }
  }
} else if (zircon_toolchain != false &&
           zircon_toolchain.environment == "multiboot") {
  # This is the top config for all code in the multiboot_toolchain.
  config("multiboot_config") {
    configs = [
      "//zircon/kernel:headers",
      "//zircon/kernel:standalone",
      "//zircon/kernel:warnings",
      "//zircon/kernel/arch/x86:abi",
      "//zircon/kernel/arch/x86:kernel",
    ]
    configs += [ "//build/config/zircon:no_sanitizers" ]
    compiler_flags = [
      "-m32",
      "-mregparm=3",
      "-fno-pic",
    ]
    asmflags = compiler_flags
    cflags = compiler_flags
    ldflags = compiler_flags
    if (zircon_toolchain.is_gcc) {
      ldflags += [ "-no-pie" ]
    } else {
      ldflags += [ "-Wl,--no-pie" ]
    }
  }

  group("multiboot_config_deps") {
  }
}
