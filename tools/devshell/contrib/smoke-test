#!/bin/bash
# Copyright 2020 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

#### CATEGORY=Run, inspect and debug
### runs tests affected by modified files

## Usage: fx smoke-test
##           [--regenerate] [--dry-run] [--verbose] [--no-feedback]
##           [-- [fx test arguments]]
##
##   --regenerate Regenerates Ninja first.
##                If your change affects test definitions or modifies
##                the build graph then regenerating will ensure that
##                this command will operate on a fresh graph.
##   --dry-run Finds affected tests but doesn't run them
##   --verbose Prints modified files and affected tests
##   --no-feedback Don't print feedback link
##   --analysis-method {gn_analyze|ninja_graph} Select gn analyze or ninja -t graph (default)
##
##   Optionally add -- followed by arguments to be passed to `fx test`
##   if tests are run. For example:
##   fx smoke-test -- -o
##   This will run `fx test [tests...] -o`

set -e

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"/../lib/vars.sh || exit $?

function usage() {
  fx-command-help
}

function get-diff-base() {
  local upstream=$(git rev-parse --abbrev-ref --symbolic-full-name "@{u}" 2>/dev/null)
  if [[ -z "${upstream}" ]]; then
    upstream="origin/master"
  fi
  local local_commit=$(git rev-list HEAD ^${upstream} --  2>/dev/null | tail -1)
  if [[ -z "${local_commit}" ]]; then
    printf "HEAD"
  else
    git rev-parse "${local_commit}"^
  fi
}

REGENERATE=
DRY_RUN=
VERBOSE=
NO_FEEDBACK=
ANALYSIS_METHOD=ninja_graph

fx-config-read

while [ $# -gt 0 ]; do
  ARG="$1"
  case "$1" in
    --regenerate) REGENERATE="1" ;;
    --verbose) VERBOSE="1" ;;
    --dry-run) DRY_RUN="1" ;;
    --no-feedback) NO_FEEDBACK="1" ;;
    --analysis-method)
      shift
      ANALYSIS_METHOD="$1"
      ;;
    --) shift; break ;;
    *) usage && printf "Unknown flag %s\n" "${ARG}" && exit 1 ;;
  esac
  shift
done

# Get modified sources
readonly MODIFIED=$(git diff --name-only $(get-diff-base))
if [[ -z "$MODIFIED" ]]; then
  exit 0
fi
if [[ -n "$VERBOSE" ]]; then
  printf "Modified files:\n%s\n\n" "${MODIFIED}"
fi

if [[ -n "$REGENERATE" ]]; then
  fx-gen
fi


readonly TESTS_JSON="${FUCHSIA_BUILD_DIR}/tests.json"

if [ "$ANALYSIS_METHOD" == "gn_analyze" ]; then

  readonly TOOL="${FUCHSIA_DIR}/tools/testing/affectedtests/testanalyze.py"

  AFFECTED=$("${TOOL}" analyze --gn-path "${PREBUILT_GN}" --tests-json "${TESTS_JSON}" --build-dir "${FUCHSIA_BUILD_DIR}" --changed-files "${MODIFIED}")

else

  # Generate Ninja graph
  readonly GRAPH=$(mktemp -u)
  trap 'rm -f "$GRAPH"' EXIT
  mkfifo "$GRAPH"
  "$PREBUILT_NINJA" -C "$FUCHSIA_BUILD_DIR" -t graph > "${GRAPH}" &

  # Build `affectedtests` if needed
  readonly TOOL="${HOST_OUT_DIR}/affectedtests"
  if [[ ! -f $TOOL ]]; then
    fx-command-run build "${TOOL#$FUCHSIA_BUILD_DIR/}"
  fi

  # Find affected tests
  AFFECTED=$("${TOOL}" --srcs "${MODIFIED}" --tests_json "${TESTS_JSON}" --graph "${GRAPH}")

fi

if [[ -n "$VERBOSE" ]]; then
  if [[ -z "$AFFECTED" ]]; then
    printf "No affected tests.\n"
  else
    printf "Affected tests:\n%s\n\n" "${AFFECTED}"
  fi
fi

# Run affected tests
if [[ -z "$DRY_RUN" && -n "$AFFECTED" ]]; then
  fx-command-run test ${AFFECTED} "$@"
fi

if [[ -z "$NO_FEEDBACK" ]]; then
  echo "Feedback? https://forms.gle/32Rhsrzo5K6ndXpg6"
fi

exit 0
