#!/bin/bash
# Copyright 2017 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

set -e

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"/lib/image_build_vars.sh
source "${FUCHSIA_DIR}/scripts/devshell/lib/disktools.sh"
source "${FUCHSIA_DIR}/buildtools/vars.sh"

qemu_dir="${BUILDTOOLS_QEMU_DIR}/bin"

arch="${FUCHSIA_ARCH}"
if [[ "${arch}" -eq "aarch64" ]]; then
  arch="arm64"
fi

# NOTE(raggi): This script makes a new fvm image each time it runs.
# Unfortunately the sparse image that is created by mkfvm is not a mountable
# partition, and so can't be reused here.

# NOTE(raggi): we might just want to run mksystempkg and mkblobstore here.

for f in "${blobstore_block}" "${cmdline}"; do
  if [[ ! -s "$f" ]]; then
    # cmdline is generated by the mksystempkg operation
    echo >&2 "Required file \"$f\" is missing, run \"fx mksystempkg\" && \"fx mkblobstore\""
    exit 1
  fi
done

cd "${FUCHSIA_BUILD_DIR}"

# 10mb is the minimum size of a minfs image
if [[ ! -f "${data_block}" ]]; then
  fx-truncate "${data_block}" "$((10 * 1024 * 1024))"
  "${ZIRCON_TOOLS_DIR}/minfs" "${data_block}" create
fi

# Note: macos doesn't have -b, so use -k and multiply below.
data_size=$(du -k "${data_block}" | cut -f 1)
blob_size="$(du -k "${blobstore_block}" | cut -f 1)"
# Add some slack on top of the base sizes, but not too much.
# TODO(raggi): we could do with `fvm create` knowing how to start from an empty
# file, and allocate enough space for all of the given inputs, as the *4 here
# is large, and accounts for smaller images such as garnet only images.
fvm_size=$(( (${blob_size} + ${data_size}) * 1024 * 4 ))
# XXX(raggi): fvm create doesn't wipe the image, so remove it first.
if [[ -f "${fvm_block}" ]]; then
  rm "${fvm_block}"
fi
fx-truncate "${fvm_block}" "${fvm_size}"
"${ZIRCON_TOOLS_DIR}/fvm" "${fvm_block}" create
"${ZIRCON_TOOLS_DIR}/fvm" "${fvm_block}" add --blobstore "${blobstore_block}" --data "${data_block}"

exec "${FUCHSIA_DIR}/zircon/scripts/run-zircon" \
  -o "${ZIRCON_BUILD_DIR}" \
  -a "${arch}" \
  -q "${qemu_dir}" \
  -x "${FUCHSIA_BUILD_DIR}/boot_bootfs.bin" \
  -d \
  -D "${fvm_block}" \
  -c "$(<"${cmdline}")" \
  "$@"
