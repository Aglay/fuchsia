# Copyright 2019 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# A set of GN build settings and helper templates used by the graphics compute
# libraries.

import("build_settings.gni")

import("//build/package.gni")
import("//third_party/vulkan_loader_and_validation_layers/layers/layers.gni")

# Generate an executable for the graphics compute project.
# This also generates a Fuchsia package for it, using a default .cmx file
# that can be overriden by providing a "meta" argument.
#
# Expect all variables supported by the Fuchsia package() template.
#
template("graphics_compute_executable") {
  _binary_name = "bin_${target_name}"

  executable(_binary_name) {
    forward_variables_from(invoker,
                           "*",
                           [
                             "loadable_modules",
                             "meta",
                             "resources",
                             "target_name",
                           ])
    output_name = invoker.target_name
  }

  package(target_name) {
    forward_variables_from(invoker, "*")
    if (!defined(deps)) {
      deps = []
    }
    deps += [ ":${_binary_name}" ]

    binary = target_name

    if (!defined(meta)) {
      meta = [
        {
          path =
              rebase_path("${graphics_compute_dir}/gn/meta/default_package.cmx")
          dest = "$target_name.cmx"
        },
      ]
    }
  }
}

# Generate an Vulkan-based executable for the graphics compute project.
# Compared to graphics_compute_executable(), this adds Vulkan dependencies
# automatically to the executable and its Fuchsia package.
#
template("graphics_compute_vulkan_executable") {
  graphics_compute_executable(target_name) {
    forward_variables_from(invoker, "*")
    if (!defined(deps)) {
      deps = []
    }
    deps += [ graphics_compute_vulkan_loader_target ]

    if (!defined(public_deps)) {
      public_deps = []
    }
    public_deps += vulkan_validation_layers.public_deps

    if (!defined(loadable_modules)) {
      loadable_modules = []
    }
    loadable_modules += vulkan_validation_layers.loadable_modules

    if (!defined(resources)) {
      resources = []
    }
    resources = vulkan_validation_layers.resources

    if (!defined(meta)) {
      meta = [
        {
          path =
              rebase_path("${graphics_compute_dir}/gn/meta/vulkan_package.cmx")
          dest = "$target_name.cmx"
        },
      ]
    }
  }
}
