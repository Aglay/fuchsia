# Copyright 2017 The Fuchsia Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

import("../../boringssl.gni")

# See //third_party/boringssl/crypto/fipsmodule/CMakeLists.txt
source_set("fipsmodule") {
  visibility = [ "//third_party/boringssl/*" ]
  sources = [
    "bcm.c",
    "is_fips.c",
  ]
  configs += [ "//third_party/boringssl:internal_config" ]
  if (current_cpu == "arm64") {
    deps = []  # See //build/secondary/third_party/boringssl/BUILD.gn
  } else if (current_cpu == "x64") {
    deps = [
      ":crypto_fipsmodule_asm",
    ]
  }
}

perlasm("crypto_fipsmodule_asm") {
  if (current_cpu == "arm64") {
    sources = [
      "aes/asm/aesv8-armx.pl",
      "bn/asm/armv8-mont.pl",
      "modes/asm/ghashv8-armx.pl",
      "sha/asm/sha1-armv8.pl",
      "sha/asm/sha256-armv8.pl",
      "sha/asm/sha512-armv8.pl",
    ]
  } else if (current_cpu == "x64") {
    sources = [
      "$target_gen_dir/sha256-x86_64.pl",
      "aes/asm/aes-x86_64.pl",
      "aes/asm/aesni-x86_64.pl",
      "aes/asm/bsaes-x86_64.pl",
      "aes/asm/vpaes-x86_64.pl",
      "bn/asm/rsaz-avx2.pl",
      "bn/asm/x86_64-mont.pl",
      "bn/asm/x86_64-mont5.pl",
      "ec/asm/p256-x86_64-asm.pl",
      "md5/asm/md5-x86_64.pl",
      "modes/asm/aesni-gcm-x86_64.pl",
      "modes/asm/ghash-x86_64.pl",
      "rand/asm/rdrand-x86_64.pl",
      "sha/asm/sha1-x86_64.pl",
      "sha/asm/sha512-x86_64.pl",
    ]
  }
  deps = [
    ":perlasm_sources",
    ":sha256_pl",
  ]
}

# The SHA-256 perl script is just SHA-512 by another name (but it must have
# that name to work).
copy("sha256_pl") {
  visibility = [ ":*" ]
  if (current_cpu == "arm64") {
    arch_part = "armv8"
  } else if (current_cpu == "x64") {
    arch_part = "x86_64"
  }
  sources = [
    "sha/asm/sha512-" + arch_part + ".pl",
  ]
  outputs = [
    "$target_gen_dir/sha256-" + arch_part + ".pl",
  ]
}

# To execute the SHA-256 script in the target_gen_dir, the support scripts must
# be there, too.
copy("perlasm_sources") {
  visibility = [ ":*" ]
  sources = perlasm_sources
  outputs = [
    "$target_gen_dir/{{source_file_part}}",
  ]
}
